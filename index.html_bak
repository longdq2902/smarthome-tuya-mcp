<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuya Manager</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        
        .card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #ccc; position: relative;}
        .card.online { border-left-color: #28a745; }
        .card.offline { border-left-color: #dc3545; }
        .card.missing-ip { border-left-color: #ffc107; background: #fffbe6; }

        .header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .name { font-weight: bold; font-size: 1.1em; color: #333; }
        .meta { font-size: 0.8em; color: #777; margin-top: 5px; }
        
        /* Hi·ªÉn th·ªã IP v√† n√∫t Edit */
        .ip-box { display: inline-flex; align-items: center; background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-top:5px; }
        .btn-edit-ip { border:none; background:none; cursor:pointer; font-size: 1.1em; margin-left: 5px; color: #007bff; }
        .btn-edit-ip:hover { color: #0056b3; }

        /* Data Sensor */
        .sensor-data { font-size: 0.9em; margin-top: 10px; border-top: 1px solid #eee; padding-top: 5px; }
        .data-row { display: flex; justify-content: space-between; padding: 3px 0; }
        .data-key { color: #555; }
        .data-val { font-weight: bold; color: #000; }

        /* N√∫t ƒëi·ªÅu khi·ªÉn */
        .controls { margin-top: 15px; display: flex; gap: 5px; }
        button.ctrl { flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-on { background: #28a745; }
        .btn-off { background: #dc3545; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }

    </style>
</head>
<body>
    <h2 style="text-align:center">üéõÔ∏è Qu·∫£n L√Ω Thi·∫øt B·ªã Tuya LAN</h2>
    <div style="text-align:center; margin-bottom:20px">
        <button onclick="loadDevices()" style="padding:10px 20px; cursor:pointer">üîÑ L√†m m·ªõi</button>
    </div>

    <div id="grid" class="grid">ƒêang t·∫£i...</div>

    <script>
        async function loadDevices() {
            const grid = document.getElementById('grid');
            try {
                const res = await fetch('/api/devices');
                const data = await res.json();
                grid.innerHTML = '';
                
                data.forEach(dev => {
                    const isOnline = dev.online;
                    let cardClass = isOnline ? 'online' : 'offline';
                    if (dev.missing_ip) cardClass = 'missing-ip';

                    // X√¢y d·ª±ng ph·∫ßn hi·ªÉn th·ªã d·ªØ li·ªáu (DPS)
                    let dpsHtml = '';
                    if (Object.keys(dev.dps).length > 0) {
                        dpsHtml = '<div class="sensor-data">';
                        for (const [k, v] of Object.entries(dev.dps)) {
                            dpsHtml += `<div class="data-row"><span class="data-key">${k}:</span> <span class="data-val">${v}</span></div>`;
                        }
                        dpsHtml += '</div>';
                    } else if (isOnline && dev.type === 'sensor') {
                        dpsHtml = '<div class="sensor-data" style="color:#aaa">Ch∆∞a c√≥ d·ªØ li·ªáu...</div>';
                    }

                    // X√¢y d·ª±ng ph·∫ßn n√∫t b·∫•m
                    let controlHtml = '';
                    if (dev.type === 'switch') {
                        controlHtml = `
                            <div class="controls">
                                <button class="ctrl btn-on" onclick="control('${dev.id}', 'on')" ${!isOnline ? 'disabled' : ''}>B·∫¨T</button>
                                <button class="ctrl btn-off" onclick="control('${dev.id}', 'off')" ${!isOnline ? 'disabled' : ''}>T·∫ÆT</button>
                            </div>`;
                    }

                    // Ph·∫ßn hi·ªÉn th·ªã IP (cho ph√©p s·ª≠a n·∫øu kh√¥ng ph·∫£i sub-device)
                    let ipDisplay = dev.ip || 'Tr·ªëng';
                    let editBtn = '';
                    if (!dev.via) { // Ch·ªâ cho s·ª≠a IP n·∫øu kh√¥ng ph·∫£i thi·∫øt b·ªã con (Zigbee)
                        editBtn = `<button class="btn-edit-ip" onclick="editIP('${dev.id}', '${dev.real_ip || ''}')" title="S·ª≠a IP">‚úèÔ∏è</button>`;
                    }
                    if (dev.missing_ip) ipDisplay = '<span style="color:red">Ch∆∞a c√≥ IP</span>';

                    const div = document.createElement('div');
                    div.className = `card ${cardClass}`;
                    div.innerHTML = `
                        <div class="header">
                            <div>
                                <div class="name">${dev.name}</div>
                                <div class="meta">${dev.category} | ${dev.type.toUpperCase()}</div>
                                <div class="ip-box">IP: ${ipDisplay} ${editBtn}</div>
                                ${dev.via ? `<div class="meta">Qua: ${dev.via}</div>` : ''}
                            </div>
                        </div>
                        ${dpsHtml}
                        ${controlHtml}
                    `;
                    grid.appendChild(div);
                });
            } catch (e) {
                grid.innerHTML = 'L·ªói k·∫øt n·ªëi server.';
            }
        }

        async function editIP(id, currentIP) {
            const newIP = prompt("Nh·∫≠p IP m·ªõi cho thi·∫øt b·ªã:", currentIP);
            if (newIP && newIP !== currentIP) {
                try {
                    const res = await fetch('/api/update_ip', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({id: id, ip: newIP})
                    });
                    const result = await res.json();
                    alert(result.message);
                    if(result.success) loadDevices();
                } catch(e) {
                    alert("L·ªói c·∫≠p nh·∫≠t: " + e);
                }
            }
        }

        async function control(id, action) {
            try {
                await fetch('/api/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id, action})
                });
                // ƒê·ª£i x√≠u r·ªìi reload ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                setTimeout(loadDevices, 1000); 
            } catch (e) { alert(e); }
        }

        loadDevices();
    </script>
</body>
</html>